# GFP Tools

## Background
The `gfp` toolset is a set of tools for dealing with molecular similarity.

An early realisation was that there are an umlimited number of different ways
in which molecular similarity can be measured. Additionally, composite fingerprints,
which might consist of multiple different fingerprints, can be extremely useful in
model building, and in concordance with human perception.

The `gfp` toolset is file based set of similarity tools, founded on the principle of 
one or more fingerprints defining the similarity measure to be used. Performance
is major design goal.

## gfp_make
The most convenient way to generate a fingerprint file is via `gfp_make`. This takes
one or more structure files and passes those molecules to one or more
executables that add a fingerprint to the output. Output is a Daylight Thor
DataTree form - an obsolete, but useful format for multiple fingerprints. The
fingerprints themselves are encoded via Daylight's du_bin2ascii function.

For example, if one were to use `gfp_make` to generate a fingerprint file containing the
MACCS keys (a variant thereof) and a linear path fingerprint, that could be done via
```
gfp_make -MK -IW file.smi > file.gfp
```
and the resulting .gfp file might look like
```
$SMI<ClC1=CC=C(S(=O)(=O)N2C(=NC=C2)C)C=C1>
FPIW<azzxzwk+2MW..6U0.4.2....c2..I+1+...JUFM    .3UIU.+.2.J6+I.200+Gs0E..1;2048;333;2048;333;1>
PCN<CHEMBL2001948>
FPMK<10EU.4A2.+X.Lp00kn03nE9CuYUh.k6d3;192;61;192;61;1>
|
```
This record consists of the smiles of the starting molecule in the `$SMI<` tag. Then follows
an encoded linear fingerprint `FPIW`. Then follows the name of the molecule `PCN`. The last
component is the MACCS keys. The delimiter separating records is the `|` character.

Any number of fingerprints can be in a `.gfp` file. The order can be important, but if all
fingerprint files are made by `gfp_make`, fingerprints will be inserted in a consistent
order.

Both fingerprints above have the number of bits and the number of bits set at the
end - the 2048 bit linear path fingerprint is truncated above.

## Fingerprint Types
There are two, orthogonal, attributes of a molecular fingerprint.

1. The molecular subset it describes
2. How it is represented.

In terms of molecular subset, the most popular kinds of fingerprints are

* Linear path fingerprints
* EC type shell fingerprints
* Atom Pair fingerprints
* Topological Torsion (short path) fingerprints
* Dictionary based fingerprints.

Each of these can be instantiated as either fixed, constant width, binary form or as a
sparse, counted form. Each of these has advantages and disadvantages.

By convention, all fixed width fingerprints will have a tag that starts with `FP`, and
all sparse, counted fingerprints will have a tag starting with `NC`, for Non Colliding.

## Collisions
Many fingerprint types can generate very large numbers of features, many more than the
length of a typical fixed length fingerprint - frequently 1k or 2k.

If a fingerprint that might assume a very large number of possible values is converted
to a fixed form, collisions are inevitable.

## Performance
Fixed width binary fingerprints can be processed extremely quickly using special hardware
instructions. But they may suffer from collisions, and they are insensitive to repeated
features in the molecule - once the bit is set, it does not matter if the molecule has
one or twenty one instances of that bit.

Sparse, counted, non colliding fingerprints on the other hand do not suffer from collisions,
all original bit numbers are preserved. But they cannot be processed nearly as quickly
as fixed width binary fingerprints. But they do retain count information, and so
accurately differentiate molecules with differing instances of a feature.

Generally fixed binary fingerprints work well in practice, and comprise the default
set of fingerprints generated by `gfp_make`. When build svm fingerprint models,
sparse, counted fingerprints generally work better.

## The standard set.
Much of the use of `gfp_make` has been for finding molecules similar to other
molecules, that are concordant with Chemist expectations of molecular similarity. For
interactive uses, fixed binary fingerprints are preferred. But these fingerprints
suffer from the repeated features flaw mentioned previously.

### Molecular Properties
One component of the standard set is a set of 8 molecular properties

* Number of atoms
* Number of rings
* Largest ring size
* Ring atoms
* Number aromatic atoms
* Number fused ring atoms
* Heteroatom count
* Unsaturation count

These are combined as a `min/max` ratio of each, generating a similarity in the
range `[0,1]`. Making these molecular properties part of the overall similarity
measure, helps mitigate the repeated feature problem. This will show up in 
the fingerprint file with the tag `MPR`.

Another component of the standard set is a linear path fingerprint, which
traces all paths up to length 7 and hashes them to a fixed width, 2048 bit
fingerprint. `FPIW`.

The other two components are based on a modification of the MACCS keys. This variant
has been heavily modified from the original implementation and now contains 192
bits. You will see two tags in the fingerprint, `FPMK` and `FPMK2`. The first is
a dictionary based fixed width fingerprint, where a bit is set if the query matches.

`FPMK2` is somewhat unusual. In order to help with the repeated feature issue, bits in
this fingerprint are only set if the feature occurs more frequently than the average
number of times that bit is hit in a large collection of molecules. So, if the
average molecule (that has that feature) has an average of 2.3 occurrences, `FPMK2` will
only be set for those moleules containing 3 or more instances.

These fingerprint components are combined with equal weights to yield a composite
fingerprint. Over many years of use, this fingerprint combination seems to do very
well in terms of agreeing with Chemists' notions of molecular similarity.

## Dictionary based fingerprints.
There are very few dictionary based fingerprint types built into `gfp_make`. The most
commonly used will be

* maccskeys
* pubchem
* abraham
* tsubstructure.

### tsubstructure
You can add your own dictionary based fingerprint by using `tsubstructure`. The simplest
way of doing this is to create a file of smarts (or a file of queries). Provide that
to gfp_make via
```
gfp_make -TSUB S:/path/to/smarts_file file.smi > file.gfp
```
If you have a file containing the names of query files, change `S:` to `Q:`. This
is the same syntax that the -q option to `tsubstructure` uses. The fingerprint will
show up as `FPTSUB`. There is no provision for multiple -TSUB options - this is
probably a bug that should be fixed.

By using the `-tsubnc` option, `tsubstructure` will generate a non colliding
counted fingerprint, with tag `NCTS`.

Early studies demonstrated that generic dictionary based fingerprints seldom do well in
models, and so they are typically not explored extensively during model building.
Custom dictionary based fingerprints, introduced via `-TSUB` can be very useful in
models.

A common use might be to take some isotopically labelled fragments (possibly
from dicer) and form a fingerprint which is the count of the number of instances
of that fragment.

```
gfp_make -TSUB M:/path/to_file.smi%onlysubiso ...
```
will do that.

## Fingerprint Weights

In any system in which multiple fingerprints are combined, the question of weighting
arises. By default, most `gfp` tools use all fingerprints in the input file, and
assign them equal weights in the overall similarity measure.

This can be overridden on the command line, at the cost of some complexity.

If you need to do this, all components of the fingerprint will need to be specified.
For example if a fingerprint was generated via
```
gfp_make -IW:APT -MAP8:Y -TSUB:file.smi
```
the tags int he fingerprint will be `FPIWAPT` and `NCEC3APT`. In order to use that
fingerprint file with different weights the `gfp` tool should accept

```
gfp_tool... -F FPIWAPT,w=0.3 -F NCEC3APT,nc,w=0.7 -P none ...
```
Once we start specifying things on the command line, we need to specify everything.
While the default fingerprint type is fixed binary, the `NCEC3APT` fingerprint
needs the `nc` qualifier to tell the tool that this is a non colliding fingerprint.
In addition, we need to tell it that there are no molecular properties in the file.

Full command line initialisation of the `gfp` environment is very complex and is
detailed below.

## Arbitrary GFP file
While most fingerprints can be constructed within `gfp_make` there may be circumstances
where a complex fingerprint is constructed externally, and it needs to be combined with
other fingerprints.

`gfp_make` supports a `-JOIN` option which allows joining an external file into the
fingerprint being generated. 

```
gfp_make -IW -EC3:APT -JOIN file.special.gfp file.smi > file.gfp
```
will have `FPIW`, `NCEC3:APT` and whatever tag is in `file.special.gfp` in the
output. Alternatively, you can generate fingerprints with `gfp_make` and use
`tdt_join` to merge in an external file - that is what `gfp_make` is doing
internally.

## Tools
The distribution comes with several tools for dealing with these `tdt` fingerprint files, look
for tools containing `*tdt*`.
. fetch_tdt
. fetch_tdt_quick
. tdt_join
. tdt_sort
. tdt_stats

## Command Line Initialization
Most `gfp` tools support `-F` and `-P` options. The `-F` option controls fingerprints, and
the `-P` option controls use of molecular properties in a calculation.

The `-P` option is easy. It can be one of two values

* MPR
* none

using 
```
gfp_make -MPR ... file.smi > file.gfp
```
generates a fingerprint that contains encoded properties in the `MPR` tag. Use the first
form if molecular properties are in the gfp file, and you want to use them in the
similarity calculation. Use `-P none` to not consider molecular properties - even if
they might be present in the input file.

```
gfp_make -IW -MPR file.smi > file.gfp
```
has both `MPR` and `FPIW` tags. But then
```
gfp_nearneighbours_single_file -n 1 -F FPIW -P none file.gfp > file.nn
```
will only use the `FPIW` fingerprint. If used without `-F` or `-P` options, the
similarity measure would be an equally weighted combination of `FPIW` and `MPR`.

This principle applies to all fingerprints.  Whatever is specified on the
command line governs what is used - regardless of what might be in the file.

The `-F` option will generally be of the form `TAG,...` where the information
following `TAG` indicates how it is used.

The following qualifiers to a tag are recognised

* w=<weight>
* fold=
* hex
* HEX
* ascii
* sparse
* fc or counted
* cosine
* fvb
* rr
* forbes
* sm
* manh
* nc
* mc01
* mcfsc
* mcsp
* scale = 
* soergel
* soergelv
* ctan
* dice
* overlap

## Atom Count Window
On many gfp tools, the `-W` option can be used to specify an atom count window.
If molecular properties are present in the fingerprint, then the number of atoms in
the molecule is known. If two molecules differ in atom count, by more than the window,
their similarity is not computed. This can result in significant speedups, at the risk
of not finding molecules that might have quite different atom counts, yet still have
a short distance.
