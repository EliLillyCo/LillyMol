# Dicer

Dicer is a tool that breaks bonds in molecules, generating fragments.

This can be useful when looking for "privileged frgaments" within a
dataset.

Dicer starts by examining the bonds in the molecule, and deciding which ones
can be broken. Generally, ring and multiple bonds will NOT be broken, although the 
precise behavior can be changed via command line options.

Dicer generates **all** fragments, including overlapping, although it can
be run in a way that mimics recap, without overlapping fragments.

## Execution

While dicer can be run with no arguments, and will generate output
it is likely most useful with various options.

### Scalability
In large molecules, with many breakable bonds, large numbers of fragments can be
generated, and this is unlikely to be useful. It is generally desirable, or
even necessary to limit the amount of fragmentation that dicer performs. There
are a number of means of doing this.

The `-X` option allows control of the number of fragments generated by any
molecule.  This is periodically checked during fragment generation, so the
actual number of fragments generated will likely exceed the limit.

For example, CHEMBL4524052 contains 636 atoms and 360 rotatable bonds. If dicer
is allowed to process this with no constraints, after 3 hours of processing
it has generated 85k fragments, with no real indication of how much remains.
After 13 hours it had generated 170k fragments. After 5 days it has generated
520k fragments. After 7 days it generated 595k fragments. After 13 days it had
generated 690k fragments. After 21 days it had generated 715k fragments. After
23 days it had generated 825k fragments.

Enable this periodic reporting with `-B freport=10000` to have it report every 10k 
fragments formed for any particular molecule.

The `-k` option, the number of bonds that can be simultaneously broken,
can also be used to limit how much fragmentation an individual
molecule can undergo. The default is 10, which will be quite unsuitable for
molecules with large numbers of rotatable bonds. Allowing 3 simultaneous bond
breakages may be a reasonable compromise. For example our large Chembl molecule
CHEMBL4524052 takes 30 minutes to generate 6.5k fragments if run with the `-k 3`
option. This is of course a completely unreasonable run-time for a single
molecule, but it does show how this option can limit the work performed.

Generally large molecules with many rotatable bonds are best excluded from dicer
processing since the sheer number of fragments generated by this one molecule
can dominate a dataset. Also, for reasonably sized fragments, they will likely
be found in smaller molecules - if the task is fragment discovery.

On reasonably sized molecules dicer is probably fast enough.  On 1000 random
molecules from Chembl, with an average of 28 heavy atoms, `dicer -k 3` runs in
2.3 seconds, generating 65k fragments. If the fragments are restricted in size
(see below) to `-m 5 -M 15` only 21k fragments are generated, but run time drops
to 0.7 seconds.

### Breakable Bonds
Dicer has internal rules for which bonds can be broken.  Generally those are
single, non-ring bonds. By default `C-C` bonds are not broken. 
The choice of which bonds are broken can be over-ridden at run time via the `-s`, `-q`,
`-n` and `-N` options.

The `-s` and `-q` options allow specifying smarts or query files that designate
bonds which are to be broken. The `-n` and `-N` options allow specification of
bonds that cannot be broken.

By default, the `-s` and `-q` options replace the existing list of breakable
bonds, but with the `-B addq` option combination, they are added. This might
be useful if you wish to add ring breaking queries. Note that the first two
matched atoms in the query define the bond. Note also that the -B option has
directives for enabling fused ring breakages.

So, if you only wanted to break at aromatic rings,

dicer `-s 'a-!@*'` would do that, or rings in general `-s '[R]-!@*'`

The one historical oversight is that by default, dicer will break amide bonds,
which is probably undesirable. Change this by adding `-B nbamide` to the
invocation.

Also by default, dicer will not break a carbon-carbon bond where one, or both,
are in a ring. Add `-B brcb` to break all ring-chain bonds.

### Fragment Size.
Another way of limiting what dicer does is to impose limits on the size of
fragments that can be produced. The `-m` and `-M` options allow specifying
a lower and an upper atom count for fragments produced. Unfortunately
the fragments are generated and then checked for violations, which is not
efficient. Work is under way to fix this.

With the -M option, you can modify the behaviour to take account of 
non ring atoms. For example, you might want `-M` to be fairly large,
say 16, so you capture some interesting ring system. But you don't
want a 16 atom fragment with no rings. Modify the -M option with
`-M 16 -M maxnr=5` which imposes a cutoff of 16 atoms, while also
discarding anything with more than 5 non ring atoms.

Within the -B option (see below) there are options for selecting
fragments based on what fraction of the whole molecule they comprise.

### Chirality
Chirality may not be useful, and it can be removed with the `-c` option.

### Element Transformations.
Experience tells us that differentiating I, Cl, and Br is seldom useful in an SAR. The
-T option enables element transformations that element conversions on the input.
Add `-T I=Cl -T Br=Cl` to translate all heavy halogens to `Cl`.

### Atom Typing
Dicer fragmentation can be very useful in *de-novo* molecule construction and
atom types can be assigned and saved with the fragments. See also the discussion
of isotopes below, since atom types are most commonly instantiated as isotopic
labels.

### The `-B` option.

As dicer evolved, it was called upon to do more and more things, and the
number of optional behaviours became quite unwieldy. It should be re-cast to
operate from a Protocol Buffer file, and that may happen. In order to deal
with the abundance of functionality, a variety of optional behaviors are
bundled in the `-B` option. Enter `-B help` for a list of those.

A more complete explanation of those sub-options follows.


#### atype=\<tag\>
Calculate atom type and dump it in frag/comp pairs
#### term
Perceive terminal groups. By default, single atom terminal groups are
not produced.
#### bscb
Allow Carbon-Carbon chain single bonds to break. By default, these are not broken.
#### xsub
Do not report fragments that are exact subsets of others. This does not work
very well, and always causes run-time problems. Best to not use.
#### nosmi
Suppress output of fragment smiles.
#### noparent
Suppress output of parent smiles.
#### time
Run timing.
#### addq
Run the -q queries in addition to the default rules.
#### WB=fname
Write smiles of just broken molecules to \<fname\>.
#### BRB
Break some kinds of cross ring bond pairs
#### BRF
Break fused rings. Generally bonds in rings are not broken. The bonds that are broken are the bonds
adjacent to the ring fusion. If this destroys aromaticity the bonds on that side will not be broken.
#### BRS
Break spiro rings. By default, these are not broken.
#### BBRK_FILE=\<fname\>
Write bonds to break to \<fname\> - no computation. Writes a .sdf file with the atom
numbers of the breakable bonds written in a tag. Use case lost in history.
#### BBRK_TAG=\<tag\>
Read bonds to be broken from sdf tag \<tag\> (def DICER_BBRK).  Use case lost in history.
#### nbamide
Do NOT break amide and amide-like bonds.
#### nbfts
**This is currently not working properly, do not use.**
Do NOT break bonds that would yield fragments too small. This is generally a good idea for
performance - should be a default.
#### appnatoms
Append the atom count to each fragment produced
#### MAXAL=\<n\>
Max atoms lost when creating any fragment
#### MINFF=\<f\>
Discard fragments that comprise less than \<f\> fraction of atoms in parent
#### MAXFF=\<f\>
Discard fragments that comprise more than \<f\> fraction of atoms in parent
#### fragstat=\<fname\>
Write fragment statistics to \<fname\>. This is an important file that gives
counts of how often each fragment occurs in the dataset.
#### fstsp=\<float\>
Fractional support level for inclusion in fragstat= file. Fragments that occur
only occasionally in the input are likely not of great interest, suppress them
with this directive. There is no option for suppressing common fragments.
#### FMC:\<qry\>
Queries that fragments reported must contain. If you are interested only in
fragments that contain a particular functional group,
```
dicer -B FMC:SMARTS:F-a
```
will only generate fragments that contain an aromatic Fluorine.
#### FMC:heteroatom
fragments reported must contain a heteroatom, :n for count
```
dicer -B FMC:heteroatom:2 ...
```
will only write fragments that contain at least two heteroatoms. The same
thing could be obtained via
```
dicer -B FMC:SMARTS:>1[!#6]' ...
```
The `heteroatom` option seems un-necessary, don't use it.
#### VF=\<n\>
Output will be viewed in `vf` with \<n\> structures per page. `vf` is an
interactive structure viewer for viewing structures at the Linux command line.
If given this option dicer writes the parent molecule so it can appear to the
top left of each page of structures.
#### flush
Flush output after each molecule.
#### lostchiral
Check each fragment for lost chirality. Generally chirality should be discarded
with the `-c` option. With bonds being broken, chirality will almost certainly be
destroyed.
#### recap
work like Recap - break all breakable bonds at once
#### freport=\<n\>
report fragment creation every \<n\> fragments for a molecule

# Output
Frequently fragment output is most useful if there is a record of how the
fragment is embedded in the parent. Isotopic atoms can be placed at the join
points with the `-I` option, select a number for the isotope to use, `-I 1` for
example.

If given aspirin
```
dicer -m 3 -M 10 -v /home/ian/aspirin.smi
```
dicer will produce
```
CC(=O)OC1=CC=CC=C1C(=O)O aspirin B=5
O=C(C)Oc1ccccc1 aspirin FRAGID=10 N= 1
O=C(O)C aspirin FRAGID=9 N= 1
O=CC aspirin FRAGID=8 N= 1
O=COc1ccccc1 aspirin FRAGID=7 N= 1
O=Cc1c(O)cccc1 aspirin FRAGID=6 N= 1
Oc1ccccc1 aspirin FRAGID=5 N= 1
O=Cc1ccccc1 aspirin FRAGID=4 N= 1
O=CO aspirin FRAGID=3 N= 2
c1ccccc1 aspirin FRAGID=2 N= 1
O=C(O)c1ccccc1 aspirin FRAGID=1 N= 1
O=C(O)c1c(O)cccc1 aspirin FRAGID=0 N= 1

```
Each parent molecule record will end with B=\<n\> where \<n\> is the number of
rotatable bonds in the molecule, and then follow the fragments generated by
that parent.

With the `-I` option, it will place an isotope on the attachment points
```
dicer -m 3 -M 10 -I 1 -v /home/ian/aspirin.smi
```
```
CC(=O)OC1=CC=CC=C1C(=O)O aspirin B=5
O=C(Oc1[1cH]cccc1)C aspirin FRAGID=11 N= 1
[1OH]C(=O)C aspirin FRAGID=10 N= 1
O=[1CH]C aspirin FRAGID=9 N= 1
O=[1CH]Oc1[1cH]cccc1 aspirin FRAGID=8 N= 1
[1OH][1CH]=O aspirin FRAGID=7 N= 1
[1OH]c1c([1CH]=O)cccc1 aspirin FRAGID=6 N= 1
[1OH]c1[1cH]cccc1 aspirin FRAGID=5 N= 1
O=[1CH]c1[1cH]cccc1 aspirin FRAGID=4 N= 1
O[1CH]=O aspirin FRAGID=3 N= 1
[1cH]1[1cH]cccc1 aspirin FRAGID=2 N= 1
OC(=O)c1[1cH]cccc1 aspirin FRAGID=1 N= 1
[1OH]c1c(C(=O)O)cccc1 aspirin FRAGID=0 N= 1
```

### Zfile
The `-Z` option writes fully split molecules to that file. Note however that
this can be time consuming.

```
dicer -m 3 -M 10 -Z zfile.smi -v file.smi
```
will create `zfile.smi` that contains each molecule with all breakable
bonds simultaneously broken. Isotopic labels are not applied - will fix...

Here is an invocation that exercises a lot of options.
```
dicer -B nbfts -B nbamide -B 'FMC:SMARTS:2[#7H0]' -B fragstat=fragstat.smi -B fstsp=0.01 -X 500 -k 3 -Z zfile.smi -m 5 -M 15 ~/rand.smi
```

### Complementary Fragments
The `-C` option writes extra records to the output that are fragments and their complements. 

TODO:ianwatson some examples of this.

## Isotopic Labels
A variety of isotopic labels can be applied to the generated fragments. The
help message generated by `dicer -I help` is

```
 -I env           atoms get isotopic labels according to their environment
 -I enva          specific atoms are added to indicate the environment
 When the 'env' or 'enva' directives are used, these isotopes or elements are added
 Descripton               iso element
 Terminal                 1   Te
 Aromatic                 2   Ar
 SaturatedCarbon          3   Cs
 SaturatedNitrogen        4   Nh
 SaturatedOxygen          5   Os
 UnsaturatedCarbon        6   Cu
 UnsaturatedNitrogen      7   Cu
 UnsaturatedOxygen        8   Cu
 AmideCarbon              9   Ac
 AmideNitrogen           10   Am
 Halogen                 11   Hg
 Nitro                   12   No
 RingCarbonAliphatic     13   Cr
 RingNitrogenAliphatic   14   Na
 -I z             atoms labelled by atomic number of neighbour
 -I ini           atoms labelled by initial atom number (debugging uses)
 -I <number>      constant isotopic label applied to all join points
 -I inc=<n>       increment existing isotopic label before labelling join points
```

The simplist form is to use a single number, which puts an isotopic label on
each attachment, `-I 1` for example. This is the most common use.

Other uses of isotopes can provide context on how the fragment was embedded in
the starting molecule. For example `-I z` will set the isotope of the fragment
atom to be the atomic number of the atom at the other end of the last bond broken
when the fragment was formed. Note that this may end up being a somewhat arbitrary choice.
For example, if a fragment is attached to both an Oxygen substituent and a Carbon
substituent, you will likely get two variants of the fragment, one with a 6
isotope, and the other with isotope 8 on the attachment point.

The `env` and `enva` options are more complex. Rather than set an isotope
that is just the atomic number of what was previously attached, now some
rudimentary atom typing is performed. The types are listed in the table 
above. It is not clear if this current choice of atom types is optimal, and
I am definitely open to modifications. 

Dicer can also use any atom typing available via the -P option to set isotopes.
Perhaps the most useful will be the `-P EXT:...` option, which allows you
to specify an external set of queries that define each molecular feature.
See the atom_typing documentation [link](../Molecule_Lib/atom_typing.md).

A typical invocation might look like
```
dicer -I atype -P EXT:/path/to/external.textproto ... file.smi
```
which will identify functional groups via the external queries, and
apply the numeric value associated with each group to the attachment
point - to the atom that used to be attached to an atom in such a
group.

The `-I env` option applies isotopes to the remaining atom. The `-I enva`
directive results in an additional atom being added, with the elements
used listed in the table above. It is not clear that this offers any
advantage over isotopic labels, and those should be preferred.
