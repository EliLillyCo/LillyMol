name: ci-testing

# Controls when the workflow will run .
on:
  # Triggers the workflow on  pull request events for master
 pull_request:
   branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest-8-core-spe
    steps:
    - uses: actions/checkout@v2
    - name: Build the project
      run: make build_docker
    - name: Run the project
      run: |
        docker-compose up -d
        sleep 30
    - name: Run unit tests
      run: |
        set -o pipefail
        make test_lillymol | tee ./unit_test_results.txt
    - name: Stop running
      run: docker-compose down
    - name: "Post to PR"
      uses: EliLillyCo/github-actions-post-to-pr@main
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        post_to_pr_definition: |
          [
            {
              "message_file": "./unit_test_results.txt",
              "title": "Unit Test",
              "compare_branches": ["master"]
            }
          ]
